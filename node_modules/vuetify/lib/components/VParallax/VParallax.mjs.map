{"version":3,"file":"VParallax.mjs","names":["VImg","useIntersectionObserver","clamp","defineComponent","getScrollParent","useRender","computed","onBeforeUnmount","ref","watch","watchEffect","useResizeObserver","useDisplay","floor","val","Math","abs","sign","VParallax","name","props","scale","type","Number","String","default","setup","slots","intersectionRef","isIntersecting","resizeRef","contentRect","height","displayHeight","root","value","$el","scrollParent","document","scrollingElement","addEventListener","onScroll","passive","removeEventListener","frame","cancelAnimationFrame","requestAnimationFrame","el","querySelector","scrollHeight","clientHeight","documentElement","scrollPos","scrollTop","window","scrollY","top","offsetTop","center","translate","sizeScale","max","style","setProperty"],"sources":["../../../src/components/VParallax/VParallax.tsx"],"sourcesContent":["// Styles\nimport './VParallax.sass'\n\n// Components\nimport { VImg } from '@/components/VImg'\n\n// Composables\nimport { useIntersectionObserver } from '@/composables/intersectionObserver'\n\n// Utilities\nimport { clamp, defineComponent, getScrollParent, useRender } from '@/util'\nimport { computed, onBeforeUnmount, ref, watch, watchEffect } from 'vue'\nimport { useResizeObserver } from '@/composables/resizeObserver'\nimport { useDisplay } from '@/composables'\n\nfunction floor (val: number) {\n  return Math.floor(Math.abs(val)) * Math.sign(val)\n}\n\nexport const VParallax = defineComponent({\n  name: 'VParallax',\n\n  props: {\n    scale: {\n      type: [Number, String],\n      default: 0.5,\n    },\n  },\n\n  setup (props, { slots }) {\n    const { intersectionRef, isIntersecting } = useIntersectionObserver()\n    const { resizeRef, contentRect } = useResizeObserver()\n    const { height: displayHeight } = useDisplay()\n\n    const root = ref<VImg>()\n\n    watchEffect(() => {\n      intersectionRef.value = resizeRef.value = root.value?.$el\n    })\n\n    let scrollParent: Element\n    watch(isIntersecting, val => {\n      if (val) {\n        scrollParent = getScrollParent(intersectionRef.value)\n        scrollParent = scrollParent === document.scrollingElement ? document as any : scrollParent\n        scrollParent.addEventListener('scroll', onScroll, { passive: true })\n        onScroll()\n      } else {\n        scrollParent.removeEventListener('scroll', onScroll)\n      }\n    })\n\n    onBeforeUnmount(() => {\n      scrollParent?.removeEventListener('scroll', onScroll)\n    })\n\n    watch(displayHeight, onScroll)\n\n    const scale = computed(() => {\n      return 1 - clamp(+props.scale)\n    })\n\n    let frame = -1\n    function onScroll () {\n      if (!isIntersecting.value) return\n\n      cancelAnimationFrame(frame)\n      frame = requestAnimationFrame(() => {\n        const el: HTMLElement | null = (root.value?.$el as Element).querySelector('.v-img__img')\n        if (!el) return\n\n        const scrollHeight = scrollParent.clientHeight ?? document.documentElement.clientHeight\n        const scrollPos = scrollParent.scrollTop ?? window.scrollY\n        const top = intersectionRef.value!.offsetTop\n        const height = contentRect.value!.height\n\n        const center = top + (height - scrollHeight) / 2\n        const translate = floor((scrollPos - center) * scale.value)\n        const sizeScale = Math.max(1, (scale.value * (scrollHeight - height) + height) / height)\n\n        el.style.setProperty('transform', `translateY(${translate}px) scale(${sizeScale})`)\n      })\n    }\n\n    useRender(() => (\n      <VImg\n        class={[\n          'v-parallax',\n          { 'v-parallax--active': isIntersecting.value },\n        ]}\n        ref={ root }\n        cover\n        onLoadstart={ onScroll }\n        onLoad={ onScroll }\n        v-slots={ slots }\n      />\n    ))\n\n    return {}\n  },\n})\n\nexport type VParallax = InstanceType<typeof VParallax>\n"],"mappings":"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"}